<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Team Daily Work Report — Final</title>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
<style>
  :root{
    --bg1:#f3f8ff; --card:#ffffff; --accent:#2f6ce5; --muted:#61708a; --glass: rgba(255,255,255,0.75);
    --success:#16a34a; --warn:#f59e0b; --danger:#ef4444;
    --neon-purple: rgba(124,58,237,0.9);
    --neon-cyan: rgba(6,182,212,0.9);
  }
  *{box-sizing:border-box}
  body{font-family:Inter,system-ui,Segoe UI,Roboto,Arial;margin:0;background:linear-gradient(180deg,#e9f3ff 0%, #ffffff 60%);color:#10203a}
  .wrap{max-width:1200px;margin:0 auto;padding:28px;}
  header{display:flex;align-items:center;justify-content:space-between;margin-bottom:18px;gap:12px}
  header h1{margin:0;font-size:20px}
  header .sub{color:var(--muted);font-size:13px}

  /* LOGIN */
  .login-screen{min-height:70vh;display:flex;align-items:center;justify-content:center}
  .card{background:var(--card);border-radius:14px;padding:28px;width:720px;box-shadow:0 10px 30px rgba(39,76,163,0.06)}
  .login-grid{display:flex;gap:24px}
  .left-col{flex:1}
  .right-col{width:260px}
  .brand{font-weight:800;font-size:22px;margin-bottom:8px}
  input,select,textarea{width:100%;padding:10px;border-radius:8px;border:1px solid #e6eefc}
  .btn{display:inline-flex;align-items:center;gap:8px;padding:10px 12px;border-radius:8px;border:0;background:var(--accent);color:white;cursor:pointer}
  .btn.ghost{background:transparent;color:var(--accent);border:1px solid #e7efff}
  .muted{color:var(--muted);font-size:13px}

  /* layout */
  .panel{background:var(--card);border-radius:14px;padding:14px;box-shadow:0 10px 30px rgba(39,76,163,0.06);margin-bottom:16px}
  .two-col{display:grid;grid-template-columns:1fr 380px;gap:16px}
  @media(max-width:1000px){ .two-col{grid-template-columns:1fr} .card{width:100%} }

  /* header user UI */
  .user-area { display:flex; align-items:center; gap:12px; }
  .login-btn { padding:8px 12px; background:transparent; border:1px solid #e7efff; border-radius:8px; cursor:pointer; color:var(--accent); font-weight:700; }
  .avatar-btn { display:flex; align-items:center; gap:8px; cursor:pointer; border-radius:10px; padding:6px; border:1px solid rgba(0,0,0,0.04); background:linear-gradient(180deg,#fff,#f7fbff); }
  .avatar { width:36px; height:36px; border-radius:50%; display:inline-flex; align-items:center; justify-content:center; background:#e8f1ff; color:#1453b9; font-weight:700; }
  .user-drop { position:relative; }
  .dropdown { position:absolute; right:0; top:44px; background:#fff; color:#10203a; border-radius:10px; padding:10px; box-shadow:0 10px 30px rgba(16,32,58,0.08); min-width:220px; display:none; z-index:200; }
  .dropdown button, .dropdown a { display:block; width:100%; text-align:left; padding:8px 10px; border-radius:8px; background:transparent; border:none; cursor:pointer; color:inherit; text-decoration:none; }

  .admin-badge { display:inline-block; padding:4px 8px; background:linear-gradient(90deg,var(--neon-purple),var(--neon-cyan)); color:white; border-radius:999px; font-weight:700; font-size:12px; margin-left:6px; }

  /* pending bar */
  .pending-bar { position:sticky; top:18px; z-index:60; display:flex; gap:10px; align-items:center; padding:10px; margin-bottom:12px; border-radius:10px; background: linear-gradient(90deg, rgba(255,255,255,0.9), rgba(250,252,255,0.95)); box-shadow: 0 6px 18px rgba(16,32,58,0.06); border:1px solid #eef6ff; }
  .pending-title{font-weight:700;color:#173c8f;font-size:14px;margin-right:8px}
  .pending-list{display:flex;gap:8px;align-items:center;flex-wrap:wrap}
  .pending-item{display:flex;gap:8px;align-items:center;padding:6px 8px;border-radius:999px;background:#fff;border:1px solid #eef6ff}
  .pending-avatar{width:32px;height:32px;border-radius:8px;display:inline-flex;align-items:center;justify-content:center;background:#e8f1ff;color:#1453b9;font-weight:700;font-size:13px}

  /* reports */
  .reports-grid{display:grid;grid-template-columns:1fr;gap:12px}
  .date-card{background:linear-gradient(180deg,#ffffff, #f7fbff);border-radius:12px;padding:12px;border:1px solid #eef6ff}
  .person-row{display:grid;grid-template-columns:1fr 120px;gap:10px;align-items:start;margin-bottom:8px;padding:10px;border-radius:10px;background:var(--glass);border:1px solid #f0f6ff}
  .avatar-lg{width:40px;height:40px;border-radius:8px;display:inline-flex;align-items:center;justify-content:center;background:#e8f1ff;color:#1453b9;font-weight:700;font-size:14px}

  /* right panel profile */
  .profile-avatar-wrap { position:relative; width:86px; height:86px; margin-bottom:8px; }
  .profile-avatar { width:86px; height:86px; border-radius:50%; background:linear-gradient(135deg,var(--neon-cyan),var(--neon-purple)); display:flex;align-items:center;justify-content:center;color:#fff;font-weight:800; font-size:28px; overflow:hidden; }
  .profile-avatar img{ width:100%; height:100%; object-fit:cover; display:block; border-radius:50%; }
  .neon-ring { position:absolute; left:-8px; top:-8px; width:102px; height:102px; border-radius:50%; pointer-events:none; background: radial-gradient(circle at 20% 20%, rgba(124,58,237,0.25), transparent 10%), radial-gradient(circle at 80% 80%, rgba(6,182,212,0.18), transparent 10%); mix-blend-mode:screen; filter:blur(8px); opacity:0.95; display:none; }

  /* admin table */
  .admin-panel { padding:14px; background:#fff;border-radius:12px; box-shadow:0 10px 30px rgba(39,76,163,0.06); }
  table.users { width:100%; border-collapse:collapse; }
  table.users th, table.users td { padding:8px 10px; border-bottom:1px solid #eef6ff; text-align:left; }
  .role-chip{ padding:4px 8px; border-radius:999px; background:#eef6ff; color:#1453b9; font-weight:700; font-size:12px; }

  /* modal */
  .modal-back { position:fixed; left:0; top:0; width:100%; height:100%; background:rgba(0,0,0,0.35); display:none; align-items:center; justify-content:center; z-index:400; }
  .modal { background:#fff; padding:16px; border-radius:12px; width:420px; box-shadow:0 20px 60px rgba(16,32,58,0.25); }
  .modal h3{ margin:0 0 8px 0; }

  @media(max-width:900px){ .two-col{grid-template-columns:1fr} }
</style>
</head>
<body>
<div class="wrap" id="appRoot">

  <!-- LOGIN SCREEN -->
  <div id="loginScreen" class="login-screen">
    <div class="card" role="main">
      <div class="login-grid">
        <div class="left-col">
          <div class="brand">Team Daily Work Report</div>
          <div class="muted">Sign in to view and manage reports. Use Google or Email/Password.</div>

          <div style="height:18px"></div>
          <label class="muted">Email</label>
          <input id="loginEmail" type="email" placeholder="your@email.com" />
          <label class="muted" style="margin-top:8px">Password</label>
          <input id="loginPass" type="password" placeholder="password" />
          <div style="display:flex;gap:8px;margin-top:12px">
            <button id="loginBtn" class="btn">Login</button>
            <button id="gotoSignup" class="btn ghost">Signup</button>
          </div>

          <div style="height:12px"></div>
          <button id="loginGoogle" class="btn ghost">Continue with Google</button>

          <div style="height:12px"></div>
          <div class="muted">Forgot password? Enter email above and click Reset below.</div>
          <div style="display:flex;gap:8px;margin-top:8px">
            <button id="resetPassBtn" class="btn ghost">Send Reset</button>
            <button id="showSignupSmall" class="btn ghost">Register</button>
          </div>
          <div id="loginMsg" class="muted" style="margin-top:10px"></div>
        </div>

        <div class="right-col">
          <div style="font-weight:700">Why login?</div>
          <ul class="muted">
            <li>Submit daily work reports</li>
            <li>Profile & avatar</li>
            <li>Role-based admin & manager controls</li>
          </ul>

          <div style="height:12px"></div>
          <div style="font-weight:700">Quick demo users</div>
          <div class="muted" style="font-size:13px;margin-top:8px">
            - Sign up to create your account.<br>- Default role = user. Admin auto-set for your email.
          </div>
        </div>
      </div>

      <!-- SIGNUP -->
      <div id="signupArea" style="display:none;margin-top:18px">
        <hr />
        <div style="margin-top:12px">
          <label class="muted">Full name</label>
          <input id="signName" type="text" placeholder="Your name" />
          <label class="muted" style="margin-top:8px">Email</label>
          <input id="signEmail" type="email" />
          <label class="muted" style="margin-top:8px">Password</label>
          <input id="signPass" type="password" />
          <div style="display:flex;gap:8px;margin-top:10px">
            <button id="signCreate" class="btn">Create account</button>
            <button id="signCancel" class="btn ghost">Cancel</button>
          </div>
          <div id="signupMsg" class="muted" style="margin-top:10px"></div>
        </div>
      </div>
    </div>
  </div>

  <!-- APP -->
  <div id="appScreen" style="display:none">
    <header>
      <div>
        <h1>Team Daily Work Report</h1>
        <div class="sub">Online (Firestore) • Grouped by date → person → tasks</div>
      </div>

      <div class="user-area">
        <div id="versionLabel" class="muted">v2 • Firestore</div>
        <div id="userAreaContainer" class="user-drop">
          <button id="btnLoginHeader" class="login-btn" style="display:none">Login</button>
          <div id="userDropdown" class="dropdown" aria-hidden="true">
            <div style="display:flex;align-items:center;gap:10px;padding-bottom:8px;border-bottom:1px solid #f0f4ff;margin-bottom:8px">
              <div id="hdrAvatar" class="avatar">U</div>
              <div style="flex:1">
                <div id="hdrName" style="font-weight:700">User</div>
                <div id="hdrEmail" class="small muted"></div>
              </div>
            </div>
            <button id="openProfileInRight">Edit Profile</button>
            <button id="openAdminDashboard" style="display:none">Admin Dashboard</button>
            <button id="btnLogout">Logout</button>
          </div>
        </div>
      </div>
    </header>

    <!-- pending bar -->
    <div id="pendingBar" class="pending-bar" style="display:none">
      <div class="pending-title">No report yet (Today):</div>
      <div id="pendingList" class="pending-list"></div>
      <div class="pending-count" id="pendingCount" style="margin-left:12px"></div>
    </div>

    <div class="panel two-col">
      <!-- LEFT -->
      <div id="left">
        <div class="panel" style="margin-bottom:12px;">
          <div style="display:flex;justify-content:space-between;align-items:center">
            <div style="display:flex;flex-direction:column">
              <div style="font-weight:700">Filters</div>
              <div class="small muted">Filter by name, date or status</div>
            </div>
            <div class="controls">
              <button class="btn ghost" id="exportCsvBtn">Export CSV</button>
              <button class="btn ghost" id="resetFiltersBtn">Reset Filters</button>
            </div>
          </div>

          <div style="height:12px"></div>
          <div class="filterbar">
            <select id="filterName"><option value="">All Names</option></select>
            <input type="date" id="filterDate" />
            <select id="filterStatus"><option value="">All Status</option><option>In Progress</option><option>Completed</option><option>Pending</option></select>
            <input type="text" id="filterSearch" placeholder="Search project / task..." style="min-width:220px;padding:8px;border-radius:8px;border:1px solid #e6eefc"/>
          </div>
        </div>

        <div id="reportsArea" class="reports-grid"></div>

        <div class="foot-row">
          <div class="small muted">Data saved in Firestore (task-manager-a4891)</div>
          <div style="display:flex;gap:8px">
            <button class="btn danger" id="clearBtn" style="display:none">Clear All Data</button>
          </div>
        </div>
      </div>

      <!-- RIGHT -->
      <aside>
        <div class="panel">
          <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:8px">
            <div style="font-weight:700">New / Update Task</div>
            <div class="small muted">Add multiple tasks per day per person</div>
          </div>
          <form id="taskForm" class="grid">
            <div>
              <label>Team Member</label>
              <select id="selName" required>
                <!-- dynamically populated -->
                <option value="">Select User</option>
              </select>
            </div>
            <div>
              <label>Project Name</label>
              <input id="inpProject" type="text" placeholder="Project / Module" required />
            </div>
            <div style="grid-column:1 / -1">
              <label>Work Description</label>
              <textarea id="inpWork" placeholder="Short description..." required></textarea>
            </div>
            <div>
              <label>Status</label>
              <select id="selStatus" required><option>In Progress</option><option>Completed</option><option>Pending</option></select>
            </div>
            <div>
              <label>Date</label>
              <input id="inpDate" type="date" />
            </div>
            <div style="grid-column:1 / -1;display:flex;gap:8px;justify-content:flex-end">
              <button class="btn" type="submit" id="addBtn">Add Task</button>
              <button class="btn ghost" type="button" id="clearFormBtn">Clear</button>
            </div>
          </form>

          <div style="height:12px"></div>

          <div style="display:flex;flex-direction:column;gap:8px">
            <button class="btn" id="viewAllBtn">Show All (no filters)</button>
            <button class="btn ghost" id="showTodayBtn">Show Today</button>
            <button class="btn ghost" id="showMineBtn">Show My</button>
          </div>
        </div>

        <!-- PROFILE PANEL -->
        <div id="profilePanel" class="panel" style="margin-top:12px;display:none">
          <div style="display:flex;gap:12px;align-items:center;">
            <div class="profile-avatar-wrap">
              <div id="profileNeon" class="neon-ring" style="display:none"></div>
              <div id="profileAvatar" class="profile-avatar">U</div>
            </div>
            <div style="flex:1">
              <div style="font-weight:800" id="profileNameDisplay">User</div>
              <div class="small muted" id="profileEmailDisplay">email</div>
            </div>
          </div>

          <hr style="margin:12px 0;border-color:#eef2ff">

          <div style="font-weight:700; margin-bottom:6px;">Edit Profile</div>
          <div class="muted" style="margin-bottom:10px;">Update your personal details</div>

          <label class="small">Display Name</label>
          <input id="profile-name" type="text" placeholder="Full name" />
          <button id="btn-update-name" class="btn" style="margin-top:8px">Update Name</button>

          <hr style="margin:12px 0;border-color:#eef2ff">

          <label class="small">Profile Photo</label>
          <input id="profile-image" type="file" accept="image/*" />
          <button id="btn-upload-photo" class="btn" style="margin-top:8px">Upload Photo</button>
          <div class="small muted" style="margin-top:6px">PNG/JPG — recommended 300x300</div>

          <hr style="margin:12px 0;border-color:#eef2ff">

          <label class="small">Change Email</label>
          <input id="profile-email" type="email" placeholder="New email" />
          <button id="btn-update-email" class="btn" style="margin-top:8px">Change Email (requires current password)</button>

          <hr style="margin:12px 0;border-color:#eef2ff">

          <label class="small">Change Password</label>
          <input id="profile-password" type="password" placeholder="New password (min 6)" />
          <button id="btn-update-password" class="btn" style="margin-top:8px">Change Password (requires current password)</button>

          <div id="profile-msg" class="muted" style="margin-top:10px"></div>
        </div>

      </aside>
    </div>

    <!-- ADMIN DASHBOARD -->
    <div id="adminDashboard" style="display:none;margin-top:12px">
      <div class="admin-panel">
        <div style="display:flex;justify-content:space-between;align-items:center;">
          <div>
            <h3 style="margin:0">Admin Dashboard</h3>
            <div class="muted">Manage users, roles and disable accounts</div>
          </div>
          <div>
            <button id="adminBackBtn" class="btn ghost">Close</button>
            <button id="adminClearData" class="btn danger" style="display:none">Clear All Data (Admin only)</button>
          </div>
        </div>

        <div style="margin-top:12px">
          <h4>Team Users</h4>
          <table class="users" id="usersTable">
            <thead><tr><th>Avatar</th><th>Name</th><th>Email</th><th>Role</th><th>Actions</th></tr></thead>
            <tbody id="usersTbody"></tbody>
          </table>
        </div>

        <div style="margin-top:12px">
          <h4>Disabled Accounts</h4>
          <div id="disabledList" class="muted">None</div>
        </div>
      </div>
    </div>

  </div>
</div>

<!-- Admin Edit Modal -->
<div id="adminModal" class="modal-back">
  <div class="modal">
    <h3>Edit User</h3>
    <div style="margin-bottom:8px">
      <label class="small">Name</label>
      <input id="modal-name" type="text" style="width:100%;padding:8px;border-radius:8px;border:1px solid #e6eefc" />
    </div>
    <div style="margin-bottom:8px">
      <label class="small">Email</label>
      <input id="modal-email" type="email" style="width:100%;padding:8px;border-radius:8px;border:1px solid #e6eefc" />
    </div>
    <div style="margin-bottom:8px">
      <label class="small">Role</label>
      <select id="modal-role" style="width:100%;padding:8px;border-radius:8px;border:1px solid #e6eefc">
        <option value="user">user</option>
        <option value="manager">manager</option>
        <option value="admin">admin</option>
        <option value="disabled">disabled</option>
      </select>
    </div>
    <div style="display:flex;gap:8px;justify-content:flex-end">
      <button id="modalCancel" class="btn ghost">Cancel</button>
      <button id="modalSave" class="btn">Save</button>
    </div>
  </div>
</div>

<!-- Firebase compat libs -->
<script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-firestore-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-storage-compat.js"></script>

<script>
/* ================= FIREBASE CONFIG ================= */
const firebaseConfig = {
  apiKey: "AIzaSyA_uO4Si54UULuKn-mFksdv5NJoML8nJvM",
  authDomain: "task-manager-a4891.firebaseapp.com",
  projectId: "task-manager-a4891",
  storageBucket: "task-manager-a4891.appspot.com",
  messagingSenderId: "31224766915",
  appId: "1:31224766915:web:03724e3ee0d8a0968d1d76"
};
firebase.initializeApp(firebaseConfig);
const auth = firebase.auth();
const db = firebase.firestore();
const storageRef = firebase.storage().ref();

/* ================ SETTINGS ================ */
const COLLECTION = 'reports_v2';
const USERS_COL = 'team_users';        // as you requested
const DELETION_REQUESTS = 'deletion_requests';
const DEFAULT_ADMIN_EMAIL = 'raghulkr1997@gmail.com'.toLowerCase();

/* ================ DOM refs ================ */
const loginScreen = document.getElementById('loginScreen');
const appScreen = document.getElementById('appScreen');
const loginEmail = document.getElementById('loginEmail');
const loginPass = document.getElementById('loginPass');
const loginBtn = document.getElementById('loginBtn');
const loginGoogle = document.getElementById('loginGoogle');
const loginMsg = document.getElementById('loginMsg');

const gotoSignup = document.getElementById('gotoSignup');
const signupArea = document.getElementById('signupArea');
const signName = document.getElementById('signName');
const signEmail = document.getElementById('signEmail');
const signPass = document.getElementById('signPass');
const signCreate = document.getElementById('signCreate');
const signCancel = document.getElementById('signCancel');
const signupMsg = document.getElementById('signupMsg');
const resetPassBtn = document.getElementById('resetPassBtn');
const showSignupSmall = document.getElementById('showSignupSmall');

const btnLoginHeader = document.getElementById('btnLoginHeader');
const userDropdown = document.getElementById('userDropdown');
const btnLogout = document.getElementById('btnLogout');
const hdrAvatar = document.getElementById('hdrAvatar');
const hdrName = document.getElementById('hdrName');
const hdrEmail = document.getElementById('hdrEmail');
const openProfileInRight = document.getElementById('openProfileInRight');
const openAdminDashboard = document.getElementById('openAdminDashboard');
const adminBackBtn = document.getElementById('adminBackBtn');
const adminDashboard = document.getElementById('adminDashboard');
const adminClearBtn = document.getElementById('adminClearData');

const filterName = document.getElementById('filterName');
const filterDate = document.getElementById('filterDate');
const filterStatus = document.getElementById('filterStatus');
const filterSearch = document.getElementById('filterSearch');
const reportsArea = document.getElementById('reportsArea');
const exportCsvBtn = document.getElementById('exportCsvBtn');
const resetFiltersBtn = document.getElementById('resetFiltersBtn');
const clearBtn = document.getElementById('clearBtn');
const viewAllBtn = document.getElementById('viewAllBtn');
const showTodayBtn = document.getElementById('showTodayBtn');
const showMineBtn = document.getElementById('showMineBtn');
const pendingBar = document.getElementById('pendingBar');
const pendingList = document.getElementById('pendingList');
const pendingCount = document.getElementById('pendingCount');

const taskForm = document.getElementById('taskForm');
const selName = document.getElementById('selName');
const inpProject = document.getElementById('inpProject');
const inpWork = document.getElementById('inpWork');
const selStatus = document.getElementById('selStatus');
const inpDate = document.getElementById('inpDate');

const profilePanel = document.getElementById('profilePanel');
const profileAvatar = document.getElementById('profileAvatar');
const profileNeon = document.getElementById('profileNeon');
const profileNameDisplay = document.getElementById('profileNameDisplay');
const profileEmailDisplay = document.getElementById('profileEmailDisplay');
const btnUpdateName = document.getElementById('btn-update-name');
const btnUploadPhoto = document.getElementById('btn-upload-photo');
const profileImageInput = document.getElementById('profile-image');
const btnUpdateEmail = document.getElementById('btn-update-email');
const btnUpdatePassword = document.getElementById('btn-update-password');
const profileMsg = document.getElementById('profile-msg');

const usersTbody = document.getElementById('usersTbody');
const disabledList = document.getElementById('disabledList');

const adminModal = document.getElementById('adminModal');
const modalName = document.getElementById('modal-name');
const modalEmail = document.getElementById('modal-email');
const modalRole = document.getElementById('modal-role');
const modalCancel = document.getElementById('modalCancel');
const modalSave = document.getElementById('modalSave');

let currentUser = null;
let usersCache = {}; // uid -> userDoc
let reports = []; // firestore reports snapshot
let unsubscribeReports = null;
let unsubscribeUsers = null;
let editingUid = null;

/* ================ HELPERS ================ */
function formatDate(d){ if(!d) return ''; const dt=new Date(d); if(isNaN(dt)) return d; return dt.toISOString().split('T')[0]; }
function escapeHtml(str=''){ return String(str).replace(/[&<>"'`=\/]/g, s => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;','/':'&#47;','`':'&#96;','=':'&#61;'})[s]); }
function debounce(fn, ms=200){ let t; return (...a)=>{ clearTimeout(t); t=setTimeout(()=>fn(...a), ms); }; }

/* ================ AUTH FLOW ================ */
// signup UI
gotoSignup.addEventListener('click', ()=> { signupArea.style.display='block'; });
showSignupSmall.addEventListener('click', ()=> { signupArea.style.display='block'; });
signCancel.addEventListener('click', ()=> { signupArea.style.display='none'; });

signCreate.addEventListener('click', async ()=>{
  const name = signName.value.trim();
  const email = signEmail.value.trim();
  const pass = signPass.value;
  signupMsg.innerText = '';
  if(!name || !email || pass.length < 6){ signupMsg.innerText = 'Fill name, valid email and pass (min 6).'; return; }
  try{
    const cred = await auth.createUserWithEmailAndPassword(email, pass);
    await cred.user.updateProfile({ displayName: name });
    // create or update users doc
    const roleToSet = (email.toLowerCase() === DEFAULT_ADMIN_EMAIL) ? 'admin' : 'user';
    await db.collection(USERS_COL).doc(cred.user.uid).set({
      uid: cred.user.uid, email: cred.user.email, name, role: roleToSet, photoURL: cred.user.photoURL || null, createdAt: new Date().toISOString()
    });
    signupMsg.innerText = 'Account created. Redirecting...';
  } catch(err){ signupMsg.innerText = 'Signup error: ' + err.message; console.error(err); }
});

// login
loginBtn.addEventListener('click', async ()=>{
  const email = loginEmail.value.trim(); const pass = loginPass.value;
  loginMsg.innerText = '';
  if(!email || !pass){ loginMsg.innerText = 'Enter email & password.'; return; }
  try{ await auth.signInWithEmailAndPassword(email, pass); loginMsg.innerText = 'Signed in.'; } catch(err){ loginMsg.innerText = 'Login error: ' + err.message; console.error(err); }
});

// google
loginGoogle.addEventListener('click', async ()=>{
  loginMsg.innerText = 'Opening Google sign-in...';
  const provider = new firebase.auth.GoogleAuthProvider();
  try{
    const result = await auth.signInWithPopup(provider);
    const u = result.user;
    const docRef = db.collection(USERS_COL).doc(u.uid);
    const snap = await docRef.get();
    if(!snap.exists){
      const roleToSet = (u.email && u.email.toLowerCase() === DEFAULT_ADMIN_EMAIL) ? 'admin' : 'user';
      await docRef.set({ uid: u.uid, email: u.email, name: u.displayName || '', role: roleToSet, photoURL: u.photoURL || null, createdAt: new Date().toISOString() });
    }
    loginMsg.innerText = 'Signed in with Google.';
  } catch(err){ loginMsg.innerText = 'Google sign-in error: ' + err.message; console.error(err); }
});

// reset password
resetPassBtn.addEventListener('click', async ()=>{
  const email = loginEmail.value.trim() || signEmail.value.trim();
  if(!email){ loginMsg.innerText = 'Enter email in the login field.'; return; }
  try{ await auth.sendPasswordResetEmail(email); loginMsg.innerText = 'Reset email sent.'; } catch(err){ loginMsg.innerText = 'Reset error: ' + err.message; console.error(err); }
});

/* ================ AUTH STATE CHANGES ================ */
auth.onAuthStateChanged(async (user) => {
  currentUser = user;
  if(user){
    // ensure user doc exists
    const docRef = db.collection(USERS_COL).doc(user.uid);
    const snap = await docRef.get();
    if(!snap.exists){
      const roleToSet = (user.email && user.email.toLowerCase() === DEFAULT_ADMIN_EMAIL) ? 'admin' : 'user';
      await docRef.set({ uid: user.uid, email: user.email, name: user.displayName || '', role: roleToSet, photoURL: user.photoURL || null, createdAt: new Date().toISOString() });
    } else {
      // force admin role if default admin email
      if(user.email && user.email.toLowerCase() === DEFAULT_ADMIN_EMAIL){
        try{ await docRef.update({ role: 'admin' }); } catch(e){ /* ignore */ }
      }
      // sync displayName/photoURL if missing
      const data = snap.data();
      const updates = {};
      if((!data.name || data.name === '') && user.displayName) updates.name = user.displayName;
      if((!data.photoURL || data.photoURL === '') && user.photoURL) updates.photoURL = user.photoURL;
      if(Object.keys(updates).length) await docRef.update(updates);
    }

    // show app
    loginScreen.style.display = 'none';
    appScreen.style.display = 'block';
    setupHeaderForUser(user);
    startRealtimeListener();
    startUsersListener();
    profilePanel.style.display = 'none';
    inpDate.value = new Date().toISOString().slice(0,10);
  } else {
    // logged out
    loginScreen.style.display = 'block';
    appScreen.style.display = 'none';
    if(unsubscribeReports){ unsubscribeReports(); unsubscribeReports = null; }
    if(unsubscribeUsers){ unsubscribeUsers(); unsubscribeUsers = null; }
    cleanupHeader();
  }
});

/* ================ HEADER & UI ================ */
function setupHeaderForUser(user){
  btnLoginHeader.style.display = 'none';
  if(!document.getElementById('headerAvatarBtn')){
    const container = document.getElementById('userAreaContainer');
    const avatarBtn = document.createElement('div');
    avatarBtn.id = 'headerAvatarBtn';
    avatarBtn.className = 'avatar-btn';
    avatarBtn.innerHTML = `<div class="avatar">${user.displayName ? user.displayName.charAt(0).toUpperCase() : (user.email ? user.email.charAt(0).toUpperCase() : 'U')}</div><div style="font-weight:700">${(user.displayName||'User').split(' ')[0]}</div>`;
    container.insertBefore(avatarBtn, userDropdown);
    avatarBtn.addEventListener('click', (e)=> { e.stopPropagation(); userDropdown.style.display = (userDropdown.style.display === 'block') ? 'none' : 'block'; });
  } else {
    const ab = document.getElementById('headerAvatarBtn');
    ab.querySelector('.avatar').textContent = user.displayName ? user.displayName.charAt(0).toUpperCase() : (user.email ? user.email.charAt(0).toUpperCase() : 'U');
    ab.querySelector('div:last-child').textContent = (user.displayName||'User').split(' ')[0];
  }

  hdrAvatar.textContent = user.displayName ? user.displayName.charAt(0).toUpperCase() : (user.email ? user.email.charAt(0).toUpperCase() : 'U');
  hdrName.textContent = user.displayName || 'User';
  hdrEmail.textContent = user.email || '';

  // show admin dashboard link based on role (users listener will manage visibility too)
  db.collection(USERS_COL).doc(user.uid).get().then(snap=>{
    const r = snap.exists ? (snap.data().role || 'user') : 'user';
    if(r === 'admin' || r === 'manager'){ openAdminDashboard.style.display = 'block'; } else { openAdminDashboard.style.display = 'none'; }
    if(r === 'admin'){ clearBtn.style.display = 'inline-block'; adminClearBtn.style.display = 'inline-block'; } else { clearBtn.style.display = 'none'; adminClearBtn.style.display = 'none'; }
  }).catch(()=>{ openAdminDashboard.style.display = 'none'; clearBtn.style.display = 'none'; adminClearBtn.style.display = 'none'; });
}

function cleanupHeader(){
  const ab = document.getElementById('headerAvatarBtn'); if(ab) ab.remove();
  btnLoginHeader.style.display = 'inline-block';
  userDropdown.style.display = 'none';
}

document.addEventListener('click', (e)=>{ const userArea = document.getElementById('userAreaContainer'); if(!userArea.contains(e.target)) userDropdown.style.display = 'none'; });
btnLogout.addEventListener('click', async ()=>{ await auth.signOut(); });

openProfileInRight.addEventListener('click', async ()=> {
  userDropdown.style.display = 'none';
  profilePanel.style.display = 'block';
  if(currentUser){
    const snap = await db.collection(USERS_COL).doc(currentUser.uid).get();
    const u = snap.exists ? snap.data() : null;
    document.getElementById('profile-name').value = u?.name || currentUser.displayName || '';
    document.getElementById('profile-email').value = u?.email || currentUser.email || '';
    profileNameDisplay.textContent = u?.name || currentUser.displayName || 'User';
    profileEmailDisplay.textContent = u?.email || currentUser.email || '';
    if(u?.photoURL){ profileAvatar.innerHTML = `<img src="${u.photoURL}" alt="avatar">`; profileNeon.style.display = 'block'; } else { profileAvatar.textContent = (u?.name||currentUser.email||'U').charAt(0).toUpperCase(); profileNeon.style.display = 'none'; }
  }
});

/* open admin */
openAdminDashboard.addEventListener('click', ()=>{ adminDashboard.style.display = 'block'; userDropdown.style.display='none'; renderUsersTable(); });
adminBackBtn.addEventListener('click', ()=>{ adminDashboard.style.display = 'none'; });

/* ================ REALTIME LISTENERS ================ */
function startRealtimeListener(){
  if(unsubscribeReports) unsubscribeReports();
  unsubscribeReports = db.collection(COLLECTION).orderBy('date','desc').onSnapshot(snap=>{
    const arr = [];
    snap.forEach(doc=>{
      const d = doc.data();
      arr.push({
        id: doc.id,
        name: d.name || '',
        project: d.project || '',
        work: d.work || '',
        status: d.status || '',
        date: d.date || formatDate(d.createdAt || new Date().toISOString()),
        createdAt: d.createdAt || new Date().toISOString(),
        ownerUid: d.ownerUid || null
      });
    });
    reports = arr;
    renderReports();
    updatePendingBar();
  }, err=>{
    console.error('Listener error', err);
    reportsArea.innerHTML = `<div class="panel small muted" style="padding:18px;text-align:center;color:#b00">Unable to load reports.</div>`;
  });
}

function startUsersListener(){
  if(unsubscribeUsers) unsubscribeUsers();
  unsubscribeUsers = db.collection(USERS_COL).onSnapshot(snap=>{
    usersCache = {};
    snap.forEach(d => usersCache[d.id] = d.data());
    populateNameFilter();
    populateTaskUserDropdown();
    renderUsersTable();
    renderDisabledList();
    updatePendingBar();
    // show/hide admin link for current user
    if(currentUser){
      db.collection(USERS_COL).doc(currentUser.uid).get().then(snapu=>{
        const r = snapu.exists ? (snapu.data().role || 'user') : 'user';
        if(r === 'admin' || r === 'manager') openAdminDashboard.style.display = 'block'; else openAdminDashboard.style.display = 'none';
        if(r === 'admin'){ document.getElementById('clearBtn').style.display = 'inline-block'; adminClearBtn.style.display = 'inline-block'; } else { document.getElementById('clearBtn').style.display = 'none'; adminClearBtn.style.display = 'none'; }
      });
    }
  }, err => console.error('users listener', err));
}

/* ================ RENDER & UI HELPERS ================ */
function populateNameFilter(){
  const names = [''];
  Object.values(usersCache).forEach(u => { if(u && u.name && u.role !== 'disabled') names.push(u.name); });
  const defaults = ['Raghul','Raj','Thangam','Robin','Saswatha','Bettina','Shehan'];
  defaults.forEach(d => { if(!names.includes(d)) names.push(d); });
  filterName.innerHTML = names.map(n => `<option value="${n}">${n || 'All Names'}</option>`).join('');
}

function populateTaskUserDropdown(){
  const dropdown = document.getElementById('selName');
  if(!dropdown) return;
  dropdown.innerHTML = `<option value="">Select User</option>`;
  Object.values(usersCache).forEach(u => {
    // include only active users (not disabled)
    if(u && u.name && u.role && u.role !== 'disabled'){
      dropdown.innerHTML += `<option value="${u.name}">${u.name}</option>`;
    }
  });
}

function renderReports(){
  const nameF = filterName.value;
  const dateF = filterDate.value;
  const statusF = filterStatus.value;
  const search = filterSearch.value.trim().toLowerCase();
  const grouped = {};
  reports.forEach(item=>{
    if(nameF && item.name !== nameF) return;
    if(dateF && item.date !== dateF) return;
    if(statusF && item.status !== statusF) return;
    if(search){
      const hay = (item.project + ' ' + item.work + ' ' + item.name).toLowerCase();
      if(!hay.includes(search)) return;
    }
    if(!grouped[item.date]) grouped[item.date] = {};
    if(!grouped[item.date][item.name]) grouped[item.date][item.name] = [];
    grouped[item.date][item.name].push(item);
  });

  const dates = Object.keys(grouped).sort((a,b)=> new Date(b) - new Date(a));
  reportsArea.innerHTML = '';
  if(dates.length===0){ reportsArea.innerHTML = `<div class="panel small muted" style="padding:18px;text-align:center">No matching reports</div>`; return; }
  dates.forEach(date=>{
    const dateCard = document.createElement('div'); dateCard.className='date-card';
    const names = Object.keys(grouped[date]); const totalTasks = names.reduce((s,n)=>s+grouped[date][n].length,0);
    dateCard.innerHTML = `<div class="date-top"><div><div class="date-title">${date}</div><div class="small muted">${names.length} person(s) • ${totalTasks} task(s)</div></div></div>`;
    names.forEach(name=>{
      const personTasks = grouped[date][name];
      const personRow = document.createElement('div'); personRow.className='person-row';
      const left = document.createElement('div'); left.className='person-left';
      const initials = (name.split(' ').map(s=>s[0]||'')[0] || name[0]||'').toUpperCase();
      const head = document.createElement('div'); head.className='person-head';
      head.innerHTML = `<div class="avatar-lg">${initials}</div><div><div class="person-name">${name} <span class="badge" style="margin-left:6px">${personTasks.length}</span></div><div class="small muted">${personTasks.map(t=>t.project).filter((v,i,self)=>self.indexOf(v)===i).join(', ')}</div></div>`;
      left.appendChild(head);
      const taskList = document.createElement('div'); taskList.className='task-list';
      personTasks.forEach(task=>{
        const tdiv = document.createElement('div'); tdiv.className='task-item';
        tdiv.innerHTML = `<div style="flex:1"><div style="font-weight:600">${escapeHtml(task.project)}</div><div class="task-meta">${escapeHtml(task.work)}</div><div class="task-meta" style="margin-top:6px"><span class="small">Added: ${new Date(task.createdAt).toLocaleString()}</span></div></div><div style="width:170px;display:flex;flex-direction:column;gap:6px;align-items:flex-end"><div class="badge" style="background:${task.status==='Completed'?'#e6ffef':'#fff2e6'};color:${task.status==='Completed'?'var(--success)':'#b77a00'}">${task.status}</div><div style="display:flex;gap:6px"><button class="btn ghost" onclick="editTask('${task.id}')">Edit</button><button class="btn" onclick="deleteTask('${task.id}')">Delete</button></div></div>`;
        taskList.appendChild(tdiv);
      });
      left.appendChild(taskList);
      const right = document.createElement('div'); right.className='person-actions';
      const email = TEAM_EMAILS && TEAM_EMAILS[name] ? TEAM_EMAILS[name] : '';
      const btnTeams = document.createElement('a'); btnTeams.className='teams-btn'; btnTeams.href=`https://teams.microsoft.com/l/chat/0/0?users=${encodeURIComponent(email)}`; btnTeams.target='_blank'; btnTeams.rel='noopener'; btnTeams.innerText = `Teams • ${name}`;
      right.appendChild(btnTeams);
      personRow.appendChild(left); personRow.appendChild(right); dateCard.appendChild(personRow);
    });
    reportsArea.appendChild(dateCard);
  });
}

/* ================ PENDING BAR ================ */
function updatePendingBar(){
  const today = new Date().toISOString().slice(0,10);
  const allUsers = Object.values(usersCache || {});
  const userNames = allUsers.filter(u=>u.role === 'user').map(u=>u.name).filter(Boolean);
  const pending = userNames.filter(name => !reports.some(r=> r.name === name && r.date === today));
  pendingList.innerHTML=''; if(pending.length===0){ pendingBar.style.display='none'; pendingCount.textContent=''; return; }
  pendingBar.style.display='flex'; pending.forEach(name=>{ const initials = (name.split(' ').map(s=>s[0]||'')[0] || name[0]||'').toUpperCase(); const item=document.createElement('div'); item.className='pending-item'; item.innerHTML=`<div class="pending-avatar">${initials}</div><div class="pending-name">${name}</div>`; pendingList.appendChild(item); });
  pendingCount.textContent = `${pending.length} pending`;
}

/* ================ CRUD ================ */
async function addReportToFirestore(item){
  const ownerUid = currentUser ? currentUser.uid : null;
  const doc = Object.assign({}, item, { ownerUid });
  return db.collection(COLLECTION).add(doc);
}

async function deleteTask(id){
  if(!confirm('Delete this task?')) return;
  try{ await db.collection(COLLECTION).doc(id).delete(); } catch(err){ alert('Delete failed: ' + err.message); console.error(err); }
}

async function editTask(id){
  try{
    const d = await db.collection(COLLECTION).doc(id).get();
    if(!d.exists) return alert('Task not found');
    const data = d.data();
    const newProject = prompt('Project name:', data.project || '');
    if(newProject === null) return;
    const newWork = prompt('Work description:', data.work || '');
    if(newWork === null) return;
    const newStatus = prompt('Status (In Progress / Completed / Pending):', data.status || 'In Progress');
    if(newStatus === null) return;
    await db.collection(COLLECTION).doc(id).update({ project: newProject.trim(), work: newWork.trim(), status: newStatus.trim() });
  } catch(err){ alert('Update failed: ' + err.message); console.error(err); }
}

/* ================ TASK FORM ================ */
taskForm.addEventListener('submit', async (ev)=>{
  ev.preventDefault();
  const name = selName.value;
  const project = inpProject.value.trim();
  const work = inpWork.value.trim();
  const status = selStatus.value;
  const date = inpDate.value || new Date().toISOString().slice(0,10);
  if(!name || !project || !work || !status) return alert('Fill all fields');
  try{ await addReportToFirestore({ name, project, work, status, date, createdAt: new Date().toISOString() }); taskForm.reset(); inpDate.value = new Date().toISOString().slice(0,10); } catch(err){ alert('Add failed: ' + err.message); console.error(err); }
});

/* ================ FILTERS & EXPORT ================ */
filterName.addEventListener('change', renderReports);
filterDate.addEventListener('change', renderReports);
filterStatus.addEventListener('change', renderReports);
filterSearch.addEventListener('input', debounce(renderReports, 250));
resetFiltersBtn.addEventListener('click', ()=>{ filterName.value=''; filterDate.value=''; filterStatus.value=''; filterSearch.value=''; renderReports(); });

exportCsvBtn.addEventListener('click', ()=>{
  if(reports.length === 0) return alert('No data to export');
  const headers = ['id','name','project','work','status','date','createdAt','ownerUid'];
  const rows = [headers.join(',')];
  reports.forEach(r=> rows.push([r.id, r.name, `"${(r.project||'').replace(/"/g,'""')}"`, `"${(r.work||'').replace(/"/g,'""')}"`, r.status, r.date, r.createdAt, r.ownerUid || ''].join(',')));
  const blob = new Blob([rows.join('\n')], {type:'text/csv'}); const a=document.createElement('a'); a.href=URL.createObjectURL(blob); a.download=`team_reports_${new Date().toISOString().slice(0,10)}.csv`; a.click();
});

/* ================ CLEAR ALL DATA (ADMIN only) ================ */
clearBtn.addEventListener('click', async ()=>{
  const confirmPass = prompt('Enter admin password to clear all data (safety prompt):');
  if(confirmPass !== 'Master@143'){ alert('Incorrect code'); return; }
  if(!confirm('Are you sure? This will permanently remove all reports and non-admin user data.')) return;
  try{
    const snap = await db.collection(COLLECTION).get(); const batch = db.batch(); snap.forEach(d=> batch.delete(d.ref)); await batch.commit();
    const usersSnap = await db.collection(USERS_COL).get(); const batch2 = db.batch();
    usersSnap.forEach(d=> { const doc = d.data(); if(doc.role !== 'admin') batch2.delete(d.ref); });
    await batch2.commit();
    alert('All non-admin user data cleared.');
  } catch(err){ alert('Clear failed: ' + err.message); console.error(err); }
});
adminClearBtn.addEventListener('click', ()=> clearBtn.click());

/* ================ PROFILE actions ================ */
btnUpdateName.addEventListener('click', async ()=>{
  const newName = document.getElementById('profile-name').value.trim();
  if(!currentUser){ profileMsg.innerText = 'Login required.'; return; }
  if(!newName){ profileMsg.innerText = 'Enter a name.'; return; }
  try{
    await currentUser.updateProfile({ displayName: newName });
    await db.collection(USERS_COL).doc(currentUser.uid).update({ name: newName });
    profileMsg.innerText = 'Name updated.';
    profileNameDisplay.textContent = newName; hdrName.textContent = newName;
    const ab = document.getElementById('headerAvatarBtn'); if(ab) ab.querySelector('div:last-child').textContent = newName.split(' ')[0];
  } catch(err){ profileMsg.innerText = 'Update name error: ' + err.message; console.error(err); }
});

btnUploadPhoto.addEventListener('click', async ()=>{
  const file = profileImageInput.files[0];
  if(!currentUser){ profileMsg.innerText = 'Login required.'; return; }
  if(!file){ profileMsg.innerText = 'Choose an image.'; return; }
  profileMsg.innerText = 'Uploading...';
  try{
    const ref = storageRef.child(`profilePictures/${currentUser.uid}_${Date.now()}`);
    await ref.put(file);
    const url = await ref.getDownloadURL();
    await currentUser.updateProfile({ photoURL: url });
    await currentUser.reload();
    await db.collection(USERS_COL).doc(currentUser.uid).update({ photoURL: url });
    profileAvatar.innerHTML = `<img src="${url}" alt="avatar">`; profileNeon.style.display = 'block';
    hdrAvatar.innerHTML = `<img src="${url}" alt="avatar" style="width:36px;height:36px;border-radius:50%">`;
    const ab = document.getElementById('headerAvatarBtn'); if(ab) ab.querySelector('.avatar').innerHTML = `<img src="${url}" style="width:36px;height:36px;border-radius:50%">`;
    profileMsg.innerText = 'Photo uploaded.';
  } catch(err){ profileMsg.innerText = 'Upload error: ' + err.message; console.error(err); }
});

btnUpdateEmail.addEventListener('click', async ()=>{
  const newEmail = document.getElementById('profile-email').value.trim();
  if(!currentUser){ profileMsg.innerText = 'Login required.'; return; }
  if(!newEmail){ profileMsg.innerText = 'Enter new email.'; return; }
  const currentPass = prompt('Enter your CURRENT password for security:');
  if(!currentPass){ profileMsg.innerText = 'Re-auth required.'; return; }
  try{
    const cred = firebase.auth.EmailAuthProvider.credential(currentUser.email, currentPass);
    await currentUser.reauthenticateWithCredential(cred);
    await currentUser.updateEmail(newEmail);
    await db.collection(USERS_COL).doc(currentUser.uid).update({ email: newEmail });
    profileEmailDisplay.textContent = newEmail; hdrEmail.textContent = newEmail; profileMsg.innerText = 'Email updated.';
  } catch(err){ profileMsg.innerText = 'Change email error: ' + err.message; console.error(err); }
});

btnUpdatePassword.addEventListener('click', async ()=>{
  const newPass = document.getElementById('profile-password').value;
  if(!currentUser){ profileMsg.innerText = 'Login required.'; return; }
  if(!newPass || newPass.length < 6){ profileMsg.innerText = 'New password must be 6+ chars.'; return; }
  const currentPass = prompt('Enter your CURRENT password for security:');
  if(!currentPass){ profileMsg.innerText = 'Re-auth required.'; return; }
  try{
    const cred = firebase.auth.EmailAuthProvider.credential(currentUser.email, currentPass);
    await currentUser.reauthenticateWithCredential(cred);
    await currentUser.updatePassword(newPass);
    profileMsg.innerText = 'Password updated.';
  } catch(err){ profileMsg.innerText = 'Change password error: ' + err.message; console.error(err); }
});

/* ================ ADMIN DASHBOARD functions ================ */
async function renderUsersTable(){
  const allUsersSnap = await db.collection(USERS_COL).orderBy('createdAt','asc').get();
  const tbody = usersTbody; tbody.innerHTML = '';
  allUsersSnap.forEach(doc=>{
    const u = doc.data();
    const tr = document.createElement('tr');
    const avatarHtml = u.photoURL ? `<img src="${u.photoURL}" style="width:36px;height:36px;border-radius:50%">` : `<div class="avatar" style="width:36px;height:36px;border-radius:50%">${(u.name||'U').charAt(0).toUpperCase()}</div>`;
    tr.innerHTML = `<td>${avatarHtml}</td><td>${escapeHtml(u.name||'')}</td><td>${escapeHtml(u.email||'')}</td><td><span class="role-chip">${u.role||'user'}</span></td>
      <td>
        <button class="btn ghost" data-uid="${u.uid}" onclick="openAdminEditModal('${u.uid}')">Edit</button>
        <button class="btn" data-uid="${u.uid}" onclick="adminResetPassword('${u.uid}','${u.email||''}')">Reset PW</button>
        <button class="btn" style="background:#ef4444" data-uid="${u.uid}" onclick="adminDisableUser('${u.uid}')">Disable</button>
      </td>`;
    tbody.appendChild(tr);
  });
}

window.openAdminEditModal = async function(uid){
  const doc = await db.collection(USERS_COL).doc(uid).get();
  if(!doc.exists) return alert('User not found');
  const u = doc.data();
  editingUid = uid;
  modalName.value = u.name || '';
  modalEmail.value = u.email || '';
  modalRole.value = u.role || 'user';
  adminModal.style.display = 'flex';
};

modalCancel.addEventListener('click', ()=>{ adminModal.style.display = 'none'; editingUid = null; });
modalSave.addEventListener('click', async ()=>{
  if(!editingUid) return;
  const name = modalName.value.trim();
  const email = modalEmail.value.trim();
  const role = modalRole.value;
  try{
    await db.collection(USERS_COL).doc(editingUid).update({ name, email, role });
    adminModal.style.display = 'none';
    editingUid = null;
    renderUsersTable();
    alert('User updated (Firestore). To change Auth email or fully disable login you need server Admin SDK for full enforcement if necessary).');
  } catch(err){ alert('Update failed: ' + err.message); console.error(err); }
});

window.adminResetPassword = async function(uid, email){
  if(!email) return alert('User has no email.');
  if(!confirm(`Send password reset email to ${email}?`)) return;
  try{ await auth.sendPasswordResetEmail(email); alert('Password reset email sent.'); } catch(err){ alert('Reset failed: ' + err.message); console.error(err); }
};

window.adminDisableUser = async function(uid){
  if(!confirm('Disable this user account? They will not be able to use the app. Reports will remain.')) return;
  try{
    await db.collection(USERS_COL).doc(uid).update({ role: 'disabled', disabledAt: new Date().toISOString() });
    alert('User disabled. They cannot login until role changed back.');
    renderUsersTable();
    renderDisabledList();
  } catch(err){ alert('Disable failed: ' + err.message); console.error(err); }
};

/* show disabled list */
function renderDisabledList(){
  const disabled = Object.values(usersCache).filter(u => u.role === 'disabled');
  if(disabled.length === 0){ disabledList.innerText = 'None'; return; }
  let html = '<ul>';
  disabled.forEach(u => html += `<li>${escapeHtml(u.name||u.email)} • disabled at: ${u.disabledAt || 'N/A'}</li>`);
  html += '</ul>'; disabledList.innerHTML = html;
}

/* ================ USERS SNAPSHOT CONTROL ================ */
/* (already implemented in startUsersListener) */

/* ================ UI INIT ================ */
viewAllBtn.addEventListener('click', ()=>{ filterName.value=''; filterDate.value=''; filterStatus.value=''; filterSearch.value=''; renderReports(); });
showTodayBtn.addEventListener('click', ()=>{ filterDate.value = new Date().toISOString().slice(0,10); filterName.value=''; filterStatus.value=''; filterSearch.value=''; renderReports(); });
showMineBtn.addEventListener('click', ()=>{
  if(!currentUser) return alert('Login required');
  const u = usersCache[currentUser.uid];
  filterName.value = u?.name || '';
  filterDate.value=''; filterStatus.value=''; filterSearch.value='';
  renderReports();
});
resetFiltersBtn.addEventListener('click', ()=>{ filterName.value=''; filterDate.value=''; filterStatus.value=''; filterSearch.value=''; renderReports(); });

clearBtn.style.display = 'none'; adminClearBtn.style.display = 'none';

/* fallback TEAM_EMAILS */
const TEAM_EMAILS = { "Raghul":"raghul@trainocate.com","Raj":"raj@trainocate.com","Thangam":"thangam@trainocate.com","Robin":"robin@trainocate.com","Saswatha":"saswatha@trainocate.com","Bettina":"bettina@trainocate.com","Shehan":"shehan@trainocate.com" };

/* initial UI state */
loginScreen.style.display = 'block'; appScreen.style.display = 'none';
inpDate.value = new Date().toISOString().slice(0,10);

/* expose certain fns to window for onclick use */
window.editTask = editTask;
window.deleteTask = deleteTask;
window.adminResetPassword = window.adminResetPassword;
window.adminDisableUser = window.adminDisableUser;
window.openAdminEditModal = window.openAdminEditModal;

/* ================ END ================ */
</script>
</body>
</html>
